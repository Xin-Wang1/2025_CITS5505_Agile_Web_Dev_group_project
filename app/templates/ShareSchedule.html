<!DOCTYPE html>
<html lang="en">

<head>
</head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Messages | My University</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}" />
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/shareschedule.css') }}">
{% endblock %}
</head>

<body>
  {% extends "base.html" %} {% block content %}
  <div class="container main-content">
    <h2>Messages</h2>
    <hr />

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %} {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">Ã—</span>
      </button>
    </div>
    {% endfor %} {% endif %} {% endwith %}

    <!-- Send Message Form -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Send New Message</h5>
        <form id="messageForm" method="POST" action="{{ url_for('send_message') }}" enctype="multipart/form-data">
          <!-- Recipient dropdown -->
          <div class="form-group">
            <label for="receiver_id">Recipient</label>
            <select class="form-control" id="receiver_id" name="receiver_id" required>
              <option value="" disabled selected>Select a user</option>
              {% for user in users %} {% if user.id != current_user.id %}
              <option value="{{ user.id }}">{{ user.username }}</option>
              {% endif %} {% endfor %}
            </select>
          </div>

          <!-- Schedule dropdown -->
          <div class="form-group">
            <label for="schedule_id">Attach to Schedule (optional)</label>
            <select class="form-control" id="schedule_id" name="schedule_id">
              <option value="" selected>None</option>
              {% for schedule in attachable_schedules %}
              <option value="{{ schedule.id }}">{{ schedule.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="content">Message Content</label>
            <textarea class="form-control" id="content" name="content" rows="4" placeholder="Enter message content"
              required></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Send</button>
        </form>
      </div>
    </div>

    <div class="messages-layout">
      <div class="message-column inbox-section">
        <h3>Inbox</h3>
        <div id="receivedMessages">
          {% for message in received_messages %}
          <div class="card mb-3">
            <div class="card-body">
              <p class="card-text">
                <strong>From:</strong> {{ message.sender.username }}
              </p>
              <p class="card-text">{{ message.content }}</p>
              <div class="schedule-container mb-5">
                <div class="table-responsive">
                  <h3 class="mb-4">Class Times</h3>
                  <table class="table table-bordered text-center">
                    <thead class="table-light">
                      <tr>
                        <th>Time</th>
                        <th>Monday</th>
                        <th>Tuesday</th>
                        <th>Wednesday</th>
                        <th>Thursday</th>
                        <th>Friday</th>
                      </tr>
                    </thead>
                    <!-- <tbody id="timetable-body-{{ message.id }}"> -->
                    <tbody id="timetable-body-message-{{ message.id }}">

                      <!-- Rows will be dynamically generated by JavaScript -->
                    </tbody>
                  </table>
                </div>
              </div>
              <p class="post-meta">
                Sent at: {{ message.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
              </p>
            </div>
          </div>
          {% else %}
          <p>No messages received yet.</p>
          {% endfor %}
        </div> <!-- close receivedMessages -->
      </div> <!-- close inbox-section -->

      <div class="message-column sent-section">
        <h3>Sent</h3>
        <div id="sentMessages">
          {% for message in sent_messages %}
          <div class="card mb-3">
            <div class="card-body">
              <p class="card-text">
                <strong>To:</strong> {{ message.receiver.username }}
              </p>
              <p class="card-text">{{ message.content }}</p>
              {% if message.schedule_id %}
              <p><strong>Schedule:</strong> {{ message.schedule_id }}</p>
              {% endif %}
              <p class="post-meta">
                Sent at: {{ message.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
              </p>
            </div>
          </div>
          {% else %}
          <p>No messages sent yet.</p>
          {% endfor %}
        </div> <!-- close sentMessages -->
      </div> <!-- close sent-section -->
    </div> <!-- close messages-layout -->
  </div>
  {% endblock %} {% block scripts %}
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    const scheduleData = {{ schedules | tojson | safe }};
  </script>
  <script>
    const scheduleDataMap = {};
    { { schedules | tojson | safe } }.forEach(schedule => {
      scheduleDataMap[schedule.id] = schedule;
    });

    const messageScheduleMap = [
      {% for message in received_messages %}
    {
      messageId: { { message.id } },
      scheduleId: { { message.schedule_id if message.schedule_id else 'null' } }
    } {% if not loop.last %}, {% endif %}
    {% endfor %}
      ];
  </script>

  <script src="{{ url_for('static', filename='js/shareschedule.js') }}"></script>
  {% endblock %}
</body>

</html>