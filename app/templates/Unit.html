{% extends "base.html" %}

{% block title %}Unit Upload{% endblock %}

{% block content %}
<h2 class="mb-4">Upload Unit Details</h2>
<form method="POST" action="{{ url_for('unit.upload_unit') }}" enctype="multipart/form-data">
  <div class="mb-3">
    <label for="file" class="form-label">Upload CSV/Excel File</label>
    <input type="file" class="form-control" id="file" name="file" accept=".csv, .xlsx" required>
  </div>
  <button type="submit" class="btn btn-primary">Upload</button>
</form>

<hr class="my-4">

<h3>Search and Select Units</h3>
<div class="mb-3">
  <input type="text" class="form-control" id="search" placeholder="Search for a unit..." onkeyup="filterUnits()">
</div>
<ul class="list-group" id="unit-list">
  {% for unit in units %}
  <li class="list-group-item d-flex justify-content-between align-items-center">
    <span>{{ unit.name }}</span>
    <button class="btn btn-sm btn-secondary" onclick="selectUnit('{{ unit.name }}', '{{ unit.credit_points }}', [])">Select</button>
  </li>
  {% endfor %}
</ul>

<hr class="my-4">

<h3>Selected Units</h3>
<ul class="list-group" id="selected-units">
  <!-- Selected units will appear here -->
</ul>

<!-- Schedule Generate Button -->
<div class="mt-4">
  <a href="/schedule" class="btn btn-success">Schedule Generate</a>
</div>

<script>
  // Filter units based on search input
  function filterUnits() {
    const searchInput = document.getElementById('search').value.toLowerCase();
    const unitList = document.getElementById('unit-list').getElementsByTagName('li');
    for (let i = 0; i < unitList.length; i++) {
      const unitName = unitList[i].getElementsByTagName('span')[0].innerText.toLowerCase();
      unitList[i].style.display = unitName.includes(searchInput) ? '' : 'none';
    }
  }

  // Add selected unit to the list
  function selectUnit(name, credits, timeSlots) {
    const selectedUnits = document.getElementById('selected-units');
    const unitItem = document.createElement('li');
    unitItem.className = 'list-group-item';
    unitItem.innerHTML = `
      <div>
        <strong>${name}</strong>
        <button class="btn btn-sm btn-link text-decoration-none" onclick="toggleDetails(this)">Show Details</button>
        <button class="btn btn-sm btn-danger float-end" onclick="removeUnit(this)">Remove</button>
      </div>
      <div class="details" style="display: none;">
        <p>Credits: ${credits}</p>
        <p>Time Slots:</p>
        <ul>
          ${timeSlots.map(slot => `<li>${slot}</li>`).join('')}
        </ul>
      </div>
    `;
    selectedUnits.appendChild(unitItem);
  }

  // Toggle unit details visibility
  function toggleDetails(button) {
    const details = button.parentElement.nextElementSibling;
    if (details.style.display === 'none') {
      details.style.display = 'block';
      button.innerText = 'Hide Details';
    } else {
      details.style.display = 'none';
      button.innerText = 'Show Details';
    }
  }

  // Remove unit from the selected list
  function removeUnit(button) {
    const unitItem = button.parentElement.parentElement;
    unitItem.remove();
  }
</script>
{% endblock %}